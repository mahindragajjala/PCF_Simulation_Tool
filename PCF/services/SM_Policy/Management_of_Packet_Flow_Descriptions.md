https://docs.google.com/document/d/1BN-dj4YY_EDEj79fe3n2X7xPoet1bYWawzdr_uxGf0E/edit?tab=t.qvvk7ft8fh45


The Management of Packet Flow Descriptions enables the UPF to perform accurate application detection when PFD(s) are provided by an ASP and then to apply enforcement actions as instructed in the PCC Rule. The operator is able to configure pre-defined PCC Rules in the SMF or dynamic PCC Rules in the PCF that include at least an application identifier for service data flow detection, charging control information, i.e. charging key and optionally the Sponsor identifier or the ASP identifier or both. Depending on the service level agreements between the operator and the Application Server Provider, it may be possible for the ASP to provide individual PFDs or the full set of PFDs for each application identifier maintained by the ASP to the SMF via the PFD Management service in the NEF (PFDF). The PFDs become part of the application detection filters in the SMF/UPF and therefore are used as part of the logic to detect traffic generated by an application. The ASP may remove or modify some or all of the PFDs which have been provided previously for one or more application identifiers. The SMF may report the application stop to the PCF for an application instance identifier as defined in clause 5.8.2.8.4 of TS 23.501 [2] if the removed/modified PFD in SMF/UPF results in that the stop of the application instance is not being able to be detected.
NOTE 1: PFD management is optionally supported in the NEF and the SMF.
The ASP manages (provision, update, delete) the PFDs through the NEF (PFDF). The PFD(s) are transferred to the SMF through the NEF (PFDF). The PFDF is a logical functionality in the NEF which receives PFD(s) from the ASP through the NEF, stores the PFD(s) in the UDR and provides the PFD(s) to the SMF(s) either on the request from ASP PFD management through NEF (PFDF) (push mode) or on the request from SMF (pull mode). The PFDF functionality is a service provided by the NEF. The ASP may provide/update/remove PFDs with an allowed delay to the NEF (PFDF). Upon reception of the request from the ASP, the NEF (PFDF) shall check if the ASP is authorized to provide/update/remove those PFD(s) and request the allowed delay. The NEF (PFDF) may be configured with a minimum allowed delay based on SLA to authorize the allowed delay provided by the ASP. When ASP and requested allowed delay are successfully authorized, the NEF (PFDF) shall translate each external Application Identifier to the corresponding Application Identifier known in the core network. The NEF (PFDF) stores the PFD(s) into the UDR.
NOTE 2: The Allowed Delay is an optional parameter. If the Allowed Delay is included, it indicates that the requested PFD(s) should be deployed within the time interval indicated by the Allowed Delay.
The PFDs may be retrieved by SMF from NEF (PFDF) in "pull" mode or may be provisioned from NEF (PFDF) to the SMF in "push" mode. When the "push" mode is used, the NEF (PFDF) retrieves from the UDR the PFDs for each application identifier and distributes them to those SMFs that enable access to those applications. The NEF (PFDF) may be configured with the list of SMFs where PFD(s) should be distributed. There are three methods to provision PFD(s) from the NEF (PFDF) to the SMF: a) Push of whole PFD(s) that can be accessed by the NEF (PFDF) according to operator configuration in NEF (PFDF) (e.g., provision per day according to operator configuration); b) Selective push of an ASP change in the PFD set (i.e. ASP changes the PFD set while operator configuration defines when to push); c) Selective push of an ASP change in the PFD set according to ASP request (i.e. ASP indicates to push changes in a PFD set within the time interval indicated by the Allowed Delay). When the "pull" mode is used, at the time a PCC Rule with an application identifier for which PFDs are not available is activated or provisioned, the SMF requests all PFDs for that application identifier from the NEF (PFDF), and NEF (PFDF) retrieves them from the UDR. The PFD(s) retrieved for an application identifier from the NEF (PFDF) are cached in the SMF, and the SMF maintains a caching timer associated to the PFD(s) to control how long the PFD(s) are valid. When the caching timer expires:
If there are still active PCC rules that refer to the corresponding application identifier, the SMF reloads the PFD(s) from the NEF (PFDF) and provides it to the UPF over N4;
If there's no active PCC rule that refers to the corresponding application identifier or the SMF removes the last PCC rule that refers to the corresponding application identifier, the SMF removes the PFD(s) identified by the application identifier and informs the UPF to remove the PFD(s) identified by the application identifier over N4.
NOTE 3: It is assumed that all SMF(s) and PFD(s) in an operator network are configured with the same default caching time value to be applied for all application identifiers. When the "pull" mode is used, the NEF (PFDF) may provide to the SMF a caching time value per application identifier. The SMF receives the caching time value together with the PFD(s) from the NEF (PFDF) over N29 and applies this value for the application identifier instead of the configured default caching time value. If no caching time value is received from NEF (PFDF), the SMF uses the configured default caching time value.
NOTE 4: The configuration of a caching time value per application identifier in NEF (PFDF) is based on the SLA between the operator and the ASP.
When only "pull" mode is supported in one PLMN, if the Allowed Delay is shorter than the caching time value stored for this application identifier, or shorter than the default caching time if no application-specific caching time is stored, the NEF (PFDF) may still store the PFD(s) to the UDR. The NEF (PFDF) shall provide an indication that the PFD(s) were stored and the caching time value to the ASP when informing that the Allowed Delay could not be met.
When either "pull" mode or "push" mode is used, if there's any update of the PFD(s) received and there are still active application detection rules in the UPF for the Application ID, the SMF shall provision the updated PFD set corresponding to the Application ID to the UPF.
NOTE 5: SMF should assure not to overload N4 signalling while managing PFD(s) to the UPF, e.g. forwarding the PFD(s) to the right UPF where the PFD(s) is enforced. When the UPF receives the updated PFD(s) from either the same or different SMF for the same application identifier, the latest received PFD(s) shall overwrite any existing PFD(s) stored in the UPF if the PFDs are managed by local O&M procedures, PFD retrieval is not used; otherwise, the PFDs retrieved from NEF (PFDF) overrides any PFDs pre-configured in the SMF. The SMF shall manage the pre-configured PFDs and PFDs provided by the NEF (PFDF) at the UPF as defined in clause 5.8.2.8.4 of TS 23.501 [2]. The SMF may differentiate the need for PFD retrieval based on operator configuration in the SMF.
The AF requests including an application identifier may trigger the activation or provisioning of a PCC Rule in the SMF by the PCF based on operator policies.


The provided text describes the process of managing Packet Flow Descriptions (PFDs) within a 5G core network, focusing on how they enable the User Plane Function (UPF) to detect application traffic and apply appropriate enforcement actions. Hereâ€™s a detailed breakdown of the key concepts and processes involved:
1. Role of PFDs and Application Detection
PFDs are used to describe traffic patterns of specific applications. 
They help the UPF to correctly identify and manage the traffic that comes from different applications.
When a PFD is provided by an Application Server Provider (ASP), the UPF can apply enforcement actions as defined in PCC (Policy and Charging Control) Rules. 
These rules can be predefined by the SMF (Session Management Function) or dynamically updated via the PCF (Policy Control Function).
2. PFD Management
PFDs can be managed (provisioned, updated, or deleted) by the ASP through the Network Exposure Function (NEF), using a service called the PFD Management Service (PFDF). This service allows the ASP to send PFDs to the SMF either in a push mode or a pull mode.
3. Push Mode vs. Pull Mode
Push Mode:
In this mode, the NEF (PFDF) pushes PFDs to the SMF. It can either push the complete set of PFDs for an application or selectively push only the updated or modified PFDs.
The NEF (PFDF) manages the distribution of PFDs to the SMF based on operator configurations.
Pull Mode:
In this mode, the SMF requests the PFDs for a specific application identifier when a PCC Rule is activated or provisioned. The NEF (PFDF) retrieves the PFDs from the User Data Repository (UDR) and provides them to the SMF.
The SMF caches the PFDs and manages the caching duration based on a timer.
4. Caching and Expiration
The SMF maintains a caching timer for the PFDs. Once the timer expires, if there are still active PCC Rules associated with the application, the SMF will reload the PFDs from the NEF (PFDF) and forward them to the UPF.
If there are no active PCC Rules, the SMF will remove the PFDs and inform the UPF to remove them as well.
Caching Time:
The NEF (PFDF) may provide a caching time specific to the application, overriding the default caching time configured in the SMF. This is usually based on the Service Level Agreement (SLA) between the operator and the ASP.
5. Allowed Delay
The Allowed Delay is an optional parameter indicating the maximum allowed time for the PFD to be deployed. It may be specified by the ASP and should be respected by the NEF (PFDF) when provisioning or updating the PFDs.
If the Allowed Delay is shorter than the caching time (either default or per application), the NEF (PFDF) may still store the PFDs but inform the ASP that the requested delay could not be met.
6. PFD Update and Overwriting
If the PFDs are updated, the SMF will provision the updated PFDs to the UPF, which will overwrite any previously stored PFDs for the corresponding application identifier.
This ensures that the UPF always uses the latest PFDs to detect and manage traffic.
7. Avoiding Signaling Overload
The SMF is responsible for managing the PFDs and ensuring that it does not overload the signaling between the SMF and UPF. This is done by forwarding the PFDs to the appropriate UPF without unnecessary duplication.
8. Role of the AF (Application Function)
The AF can request an application identifier, which can trigger the activation or provisioning of a PCC Rule in the SMF by the PCF. This further ties together the PFDs, the PCC Rules, and the application detection logic within the UPF.
9. PFDs and Enforcement
The PFDs become part of the logic in the SMF and UPF to detect traffic and apply appropriate PCC enforcement actions. This allows the network to manage the flow of data for specific applications based on the rules defined by the operator and ASP.
Summary
The management of PFDs ensures that the UPF can accurately detect traffic associated with different applications and apply relevant enforcement actions.
The process involves the ASP, NEF (PFDF), SMF, and UPF working together to manage, update, cache, and apply PFDs.
Both push and pull modes are used for transferring PFDs between the NEF (PFDF) and SMF.
The SMF plays a central role in maintaining caching timers, managing PFDs, and avoiding signaling overload.
The Allowed Delay and caching configurations are key elements that influence the timing and delivery of PFDs.


Packet Flow Description
PFD (Packet Flow Description) is a set of information enabling the detection of application traffic.
Each PFD may be identified by a PFD id. A PFD id is unique in the scope of a particular application identifier.
Conditions for when PFD ID is included in the PFD is described in TS 29.551 [17]. There may be different PFD types associated to an application identifier.
A PFD include the following information:
- PFD id; and
- one or more of the following:
- 3-tuple(s) including protocol, server side IP address and port number;
- the significant parts of the URL to be matched, e.g. host name;
- a Domain name matching criteria and information about applicable protocol(s).
NOTE 1: Based on the agreement between AF and mobile operator, the PFD can be designed to convey proprietary extension for proprietary application traffic detection mechanisms.
NOTE 2: How the PFD(s) are used in service flow detection is specified in clause 6.2.2.2.
